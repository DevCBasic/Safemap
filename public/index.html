<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>SafeMap · OpenStreetMap + Leaflet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>

  <!-- Styles -->
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header>
    <div class="header-inner">
      <div class="brand">
        <span class="dot"></span>
        <span>SafeMap</span>
      </div>
      <div class="header-tools">
        <button id="btnToggleSidebar" class="toggle" title="Thu gọn/hiện bảng điều khiển">☰ Bảng điều khiển</button>
      </div>
    </div>
  </header>

  <main>
    <!-- Sidebar -->
    <aside id="sidebar">
      <div class="section">
        <h3>1) Tìm kiếm vị trí</h3>
        <div class="searchbox">
          <label for="search">Nhập tên địa điểm, địa chỉ…</label>
          <input id="search" type="text" placeholder="VD: Hồ Gươm, Hà Nội">
          <div id="suggest" class="suggest" style="display:none;"></div>
        </div>
        <div class="hint">Chọn 1 kết quả để zoom tới vị trí và tự điền Lat/Lng; hoặc nhấp trên bản đồ để lấy toạ độ.</div>
      </div>

      <div class="section">
        <h3>2) Đăng bài (ghi vào hệ thống)</h3>
        <div class="row">
          <div>
            <label for="lat">Vĩ độ (lat)</label>
            <input id="lat" type="number" step="any" placeholder="21.0285">
          </div>
          <div>
            <label for="lng">Kinh độ (lng)</label>
            <input id="lng" type="number" step="any" placeholder="105.8542">
          </div>
        </div>

        <label for="event">Sự kiện</label>
        <textarea id="event" rows="2" placeholder="Mô tả sự kiện..."></textarea>

        <label for="author">Tên người đăng</label>
        <input id="author" type="text" placeholder="Nguyễn Văn A">

        <div class="toolbar">
          <button class="btn-primary" id="btnAddPost">Đăng bài</button>
          <button class="btn-secondary" id="btnFitAll">Fit tất cả marker</button>
        </div>
        <div class="hint">Marker <b>đỏ</b> chỉ xuất hiện sau khi hệ thống xử lý và cập nhật <code>processed_markers.json</code>. Không tạo marker tạm khi đăng.</div>
      </div>

      <div class="section">
        <h3>Trạng thái</h3>
        <div id="syncStatus" class="status">Đồng bộ marker đã xử lý: đang chờ...</div>
      </div>
    </aside>

    <!-- Map -->
    <div id="mapWrap">
      <!-- Fallback min-height để map luôn có chỗ, ngay cả khi CSS chưa tải -->
      <div id="map" style="min-height:480px"></div>
    </div>
  </main>

  <div id="toast" class="toast" style="display:none;"></div>

  <script>
    // Đảm bảo Leaflet đã load (vì script dùng defer)
    window.addEventListener('DOMContentLoaded', () => {
      if (!window.L) {
        alert('Leaflet chưa tải được. Kiểm tra mạng/CDN.');
        return;
      }
      initApp();
    });

    function initApp(){
      /* ===== Config ===== */
      const API_BASE = "http://localhost:3000";
      const PROCESSED_POLL_MS = 10000; // 10s

      /* ===== Map Init ===== */
      const map = L.map('map', { zoomControl: true }).setView([21.0285, 105.8542], 13);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      })
      .on('tileerror', () => console.warn('Tile load error'))
      .addTo(map);

      // đảm bảo tính lại kích thước sau khi render
      setTimeout(() => map.invalidateSize(true), 250);

      // Red marker layer
      const redLayer = L.layerGroup().addTo(map);
      const redIcon = new L.Icon({
        iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
        shadowUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
        iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowSize:[41,41]
      });

      /* ===== DOM ===== */
      const $sidebar = document.getElementById('sidebar');
      const $btnToggleSidebar = document.getElementById('btnToggleSidebar');
      const $search = document.getElementById('search');
      const $suggest = document.getElementById('suggest');
      const $lat = document.getElementById('lat');
      const $lng = document.getElementById('lng');
      const $event = document.getElementById('event');
      const $author = document.getElementById('author');
      const $btnAddPost = document.getElementById('btnAddPost');
      const $btnFitAll = document.getElementById('btnFitAll');
      const $syncStatus = document.getElementById('syncStatus');
      const $toast = document.getElementById('toast');

      /* Sidebar toggle */
      $btnToggleSidebar.addEventListener('click', () => {
        $sidebar.classList.toggle('hidden');
        setTimeout(() => map.invalidateSize(true), 220);
      });

      /* ===== Search (Nominatim) ===== */
      let searchTimer=null;
      $search.addEventListener('input', ()=>{
        const q=$search.value.trim();
        if(searchTimer) clearTimeout(searchTimer);
        if(!q){ hideSuggest(); return; }
        searchTimer=setTimeout(()=>searchPlace(q), 350);
      });

      function searchPlace(q){
        const url = `https://nominatim.openstreetmap.org/search?format=jsonv2&addressdetails=1&limit=8&q=${encodeURIComponent(q)}`;
        fetch(url, { headers:{ 'Accept':'application/json' }})
          .then(r=>r.json())
          .then(list=>{
            if(!Array.isArray(list) || !list.length){ hideSuggest(); return; }
            $suggest.innerHTML = '';
            list.forEach(item=>{
              const li=document.createElement('div');
              li.className='suggest-item';
              const label = escapeHtml(item.display_name || `${item.lat},${item.lon}`);
              li.textContent = label;
              li.addEventListener('click', ()=>{
                const lat=parseFloat(item.lat), lon=parseFloat(item.lon);
                map.setView([lat,lon], 16);
                $lat.value = lat.toFixed(6);
                $lng.value = lon.toFixed(6);
                hideSuggest();
              });
              $suggest.appendChild(li);
            });
            $suggest.style.display='block';
          })
          .catch(()=>hideSuggest());
      }
      function hideSuggest(){ $suggest.style.display='none'; $suggest.innerHTML=''; }
      document.addEventListener('click', (e)=>{ if(!e.target.closest('.searchbox')) hideSuggest(); });

      // click map -> điền lat/lng
      map.on('click', e => {
        $lat.value = e.latlng.lat.toFixed(6);
        $lng.value = e.latlng.lng.toFixed(6);
      });

      /* ===== Submit post (no temp marker, no download) ===== */
      $btnAddPost.addEventListener('click', async ()=>{
        const lat=parseFloat($lat.value), lng=parseFloat($lng.value);
        const eventText=($event.value||'').trim();
        const author=($author.value||'').trim();
        if(!isFinite(lat)||!isFinite(lng)){ alert('Vui lòng nhập Lat/Lng hợp lệ.'); return; }
        if(!eventText){ alert('Vui lòng nhập nội dung sự kiện.'); return; }

        const post={ lat, lng, event:eventText, author: author || 'Ẩn danh', timestamp:new Date().toISOString() };

        try{
          const res = await fetch(`http://localhost:3000/api/posts`, {
            method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(post)
          });
          if(!res.ok) throw new Error('API error');
          showToast('Đã ghi bài vào hệ thống. Marker sẽ xuất hiện sau xử lý.');
          $event.value=''; $lat.value=''; $lng.value='';
        }catch(e){
          console.error(e);
          alert('Không gửi được về server dự án. Hãy chạy server ở http://localhost:3000');
        }
      });

      /* ===== Fit all processed markers ===== */
      $btnFitAll.addEventListener('click', ()=>{
        const group=L.featureGroup(); redLayer.eachLayer(l=>group.addLayer(l));
        if(group.getLayers().length) map.fitBounds(group.getBounds().pad(0.15));
        else alert('Chưa có marker nào (đợi hệ thống xử lý).');
      });

      /* ===== Auto-sync processed markers ===== */
      let lastProcessedHash = "";
      async function syncProcessed() {
        try {
          const res = await fetch(`http://localhost:3000/api/processed`, { headers: { "Accept": "application/json" }});
          if (!res.ok) throw new Error("fetch processed failed");
          const data = await res.json();
          const hash = quickHash(JSON.stringify(data));
          if (hash !== lastProcessedHash) {
            lastProcessedHash = hash;
            redLayer.clearLayers();
            (Array.isArray(data) ? data : []).forEach(item=>{
              const lat = parseFloat(item.lat);
              const lng = parseFloat(item.lng ?? item.lon ?? item.longitude);
              if (isFinite(lat) && isFinite(lng)) {
                // chỉ hiện 3 mục: Sự kiện, Mức độ khẩn cấp, Nguồn
                const ev       = item['sự kiện'] ?? item['su_kien'] ?? item.event ?? '';
                const urgency  = item['mức độ khẩn cấp'] ?? item['muc_do_khan_cap'] ?? item.urgency ?? item.severity ?? '';
                const source   = item['nguồn'] ?? item['nguon'] ?? item.source ?? '';

                const popup = `
                  <div class="popup-card">
                    <div><b>Sự kiện:</b> ${escapeHtml(ev || '—')}</div>
                    ${urgency ? `<div><b>Mức độ khẩn cấp:</b> ${escapeHtml(urgency)}</div>` : ''}
                    ${source ? `<div><b>Nguồn:</b> ${escapeHtml(source)}</div>` : ''}
                  </div>
                `;

                L.marker([lat, lng], { icon: redIcon }).bindPopup(popup).addTo(redLayer);
              }
            });
            $syncStatus.textContent = `Đồng bộ marker đã xử lý: ${new Date().toLocaleString()}`;
          }
        } catch (e) {
          $syncStatus.textContent = "Đồng bộ marker đã xử lý: lỗi kết nối.";
        }
      }
      syncProcessed();
      setInterval(syncProcessed, PROCESSED_POLL_MS);

      /* ===== Helpers ===== */
      function quickHash(str){ let h=0,i=0; for(;i<str.length;i++) h=(h<<5)-h+str.charCodeAt(i)|0; return String(h); }
      function escapeHtml(str){
        return String(str).replace(/[&<>"'`=\/]/g, s => ({
          '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;', '/':'&#x2F;', '`':'&#x60;', '=':'&#x3D;'
        }[s]));
      }
      function showToast(msg){ const $t=document.getElementById('toast'); $t.textContent=msg; $t.style.display='block'; setTimeout(()=>{$t.style.display='none'},2500); }

      // Reflow on window resize (tránh “mất map” do container đổi kích thước)
      window.addEventListener('resize', () => { setTimeout(()=>map.invalidateSize(true), 150); });
    }
  </script>
</body>
</html>
